# Makefile for ClickHouse Analytics Setup
.PHONY: help setup start stop restart logs status test-pg test-ch clean

.DEFAULT_GOAL := help

# Colors
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m

COMPOSE := docker-compose -f docker-compose-clickhouse.yml

help: ## Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§
	@echo "$(BLUE)================================================================$(NC)"
	@echo "$(GREEN)ClickHouse Analytics - Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯$(NC)"
	@echo "$(BLUE)================================================================$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

setup: ## Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ (ÙÙ‚Ø· Ø¨Ø§Ø± Ø§ÙˆÙ„)
	@echo "$(GREEN)ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ…...$(NC)"
	@chmod +x setup-clickhouse.sh
	@./setup-clickhouse.sh

start: ## Ø´Ø±ÙˆØ¹ Ù‡Ù…Ù‡ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
	@echo "$(GREEN)â–¶ï¸  Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§...$(NC)"
	@$(COMPOSE) up -d
	@sleep 5
	@$(MAKE) status

stop: ## Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
	@echo "$(YELLOW)â¸ï¸  Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§...$(NC)"
	@$(COMPOSE) down

restart: ## Ø±ÛŒØ³ØªØ§Ø±Øª Ù‡Ù…Ù‡ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
	@$(MAKE) stop
	@sleep 2
	@$(MAKE) start

logs: ## Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§
	@$(COMPOSE) logs -f

logs-sync: ## Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ sync service
	@$(COMPOSE) logs -f pg-to-clickhouse-sync

logs-pg: ## Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ PostgreSQL
	@$(COMPOSE) logs -f postgres-source

logs-ch: ## Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ ClickHouse
	@$(COMPOSE) logs -f clickhouse

status: ## Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
	@echo "$(BLUE)ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§:$(NC)"
	@$(COMPOSE) ps

test-pg: ## ØªØ³Øª PostgreSQL
	@echo "$(GREEN)ğŸ§ª ØªØ³Øª PostgreSQL...$(NC)"
	@$(COMPOSE) exec -T postgres-source psql -U exchange_admin -d crypto_exchange -c "SELECT 'PostgreSQL OK!' as status, COUNT(*) as total_transactions FROM transactions;"

test-ch: ## ØªØ³Øª ClickHouse
	@echo "$(GREEN)ğŸ§ª ØªØ³Øª ClickHouse...$(NC)"
	@$(COMPOSE) exec -T clickhouse clickhouse-client --query "SELECT 'ClickHouse OK!' as status, COUNT(*) as total_transactions FROM crypto_analytics.transactions;"

test: test-pg test-ch ## Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§

stats: ## Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
	@echo "$(BLUE)ğŸ“ˆ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:$(NC)"
	@echo ""
	@echo "$(YELLOW)PostgreSQL (Source):$(NC)"
	@$(COMPOSE) exec -T postgres-source psql -U exchange_admin -d crypto_exchange -c "SELECT 'Users' as table_name, COUNT(*) as count FROM users UNION ALL SELECT 'Wallets', COUNT(*) FROM wallets UNION ALL SELECT 'Transactions', COUNT(*) FROM transactions UNION ALL SELECT 'Alerts', COUNT(*) FROM alerts ORDER BY table_name;"
	@echo ""
	@echo "$(YELLOW)ClickHouse (Analytics):$(NC)"
	@$(COMPOSE) exec -T clickhouse clickhouse-client --query "SELECT 'Users' as table_name, COUNT(*) as count FROM crypto_analytics.users UNION ALL SELECT 'Transactions', COUNT(*) FROM crypto_analytics.transactions UNION ALL SELECT 'Alerts', COUNT(*) FROM crypto_analytics.alerts ORDER BY table_name FORMAT PrettyCompact;"

shell-pg: ## Ø§ØªØµØ§Ù„ Ø¨Ù‡ PostgreSQL shell
	@$(COMPOSE) exec postgres-source psql -U exchange_admin -d crypto_exchange

shell-ch: ## Ø§ØªØµØ§Ù„ Ø¨Ù‡ ClickHouse client
	@$(COMPOSE) exec clickhouse clickhouse-client --database crypto_analytics

ui: ## Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ClickHouse UI
	@echo "$(GREEN)ğŸ¨ Opening ClickHouse UI...$(NC)"
	@open http://localhost:8124 2>/dev/null || xdg-open http://localhost:8124 2>/dev/null || echo "$(YELLOW)Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯: http://localhost:8124$(NC)"

restart-sync: ## Ø±ÛŒØ³ØªØ§Ø±Øª ÙÙ‚Ø· sync service
	@echo "$(YELLOW)ğŸ”„ Ø±ÛŒØ³ØªØ§Ø±Øª sync service...$(NC)"
	@$(COMPOSE) restart pg-to-clickhouse-sync
	@sleep 2
	@$(MAKE) logs-sync

clean: ## Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª
	@echo "$(YELLOW)ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ...$(NC)"
	@rm -rf sync-service/logs/*.log
	@echo "$(GREEN)âœ… Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯$(NC)"

clean-all: ## Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ú†ÛŒØ² (Ø®Ø·Ø±Ù†Ø§Ú©!)
	@echo "$(YELLOW)âš ï¸  Ø§ÛŒÙ† Ú©Ø§Ø± Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ùˆ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù‡!$(NC)"
	@read -p "Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		$(COMPOSE) down -v; \
		rm -rf sync-service/logs/*; \
		echo "$(GREEN)âœ… Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù¾Ø§Ú© Ø´Ø¯$(NC)"; \
	fi

query-anomalies: ## Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ú©ÙˆÚ©
	@echo "$(BLUE)ğŸ” ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ú©ÙˆÚ© (Risk > 70):$(NC)"
	@$(COMPOSE) exec -T clickhouse clickhouse-client --query "SELECT transaction_id, user_id, currency, usd_amount, risk_score, flag_reason, created_at FROM crypto_analytics.transactions WHERE risk_score > 70 ORDER BY risk_score DESC LIMIT 10 FORMAT PrettyCompact;"

query-hourly: ## Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± Ø³Ø§Ø¹ØªÛŒ
	@echo "$(BLUE)ğŸ“Š Ø¢Ù…Ø§Ø± Ø³Ø§Ø¹ØªÛŒ Ø§Ù…Ø±ÙˆØ²:$(NC)"
	@$(COMPOSE) exec -T clickhouse clickhouse-client --query "SELECT hour, total_transactions, total_volume_usd, flagged_transactions, avg_risk_score FROM crypto_analytics.hourly_metrics WHERE toDate(hour) = today() ORDER BY hour DESC FORMAT PrettyCompact;"

backup-pg: ## Ø¨Ú©Ø§Ù¾ Ø§Ø² PostgreSQL
	@echo "$(GREEN)ğŸ’¾ Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ú©Ø§Ù¾ Ø§Ø² PostgreSQL...$(NC)"
	@mkdir -p backups
	@$(COMPOSE) exec -T postgres-source pg_dump -U exchange_admin crypto_exchange > backups/postgres_backup_$$(date +%Y%m%d_%H%M%S).sql
	@echo "$(GREEN)âœ… Ø¨Ú©Ø§Ù¾ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ Ø¯Ø± backups/$(NC)"

info: ## Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…
	@echo "$(BLUE)================================================================$(NC)"
	@echo "$(GREEN)â„¹ï¸  Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…$(NC)"
	@echo "$(BLUE)================================================================$(NC)"
	@echo ""
	@echo "$(YELLOW)Ù†Ù‚Ø§Ø· Ø¯Ø³ØªØ±Ø³ÛŒ:$(NC)"
	@echo "  â€¢ PostgreSQL:         localhost:5434"
	@echo "  â€¢ ClickHouse HTTP:    localhost:8123"
	@echo "  â€¢ ClickHouse Native:  localhost:9000"
	@echo "  â€¢ ClickHouse UI:      http://localhost:8124"
	@echo ""
	@echo "$(YELLOW)Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ±ÙˆØ¯:$(NC)"
	@echo "  PostgreSQL:"
	@echo "    - User: exchange_admin"
	@echo "    - Password: Exchange2024Secure!"
	@echo "    - Database: crypto_exchange"
	@echo ""
	@echo "  ClickHouse:"
	@echo "    - User: analytics_user"
	@echo "    - Password: ClickHouse2024!"
	@echo "    - Database: crypto_analytics"
	@echo ""
	@echo "$(GREEN)Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø¯Ø³ØªÙˆØ±Ø§Øª: make help$(NC)"
	@echo "$(BLUE)================================================================$(NC)"